// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  password       String
  firstName      String
  lastName       String
  role           Role     @default(STUDENT)
  profilePicture String?
  branchId       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Contact & personal fields
  phone       String?
  address     String?
  birthday    DateTime?

  // Parent/Guardian info (for students under 18)
  parentName  String?
  parentPhone String?
  parentEmail String?

  branch            Branch?                  @relation(fields: [branchId], references: [id], onDelete: SetNull)
  enrollments       Enrollment[]
  payments          Payment[]
  instructorClasses Class[]                  @relation("ClassInstructor")
  paymentConfig     InstructorPaymentConfig?

  @@map("users")
}

enum Role {
  ADMIN
  INSTRUCTOR
  STUDENT
  OFFICE_WORKER
}

model Class {
  id           String          @id @default(uuid())
  name         String
  description  String?
  branchId     String?
  instructorId String?
  maxCapacity  Int
  fee          Float?
  recurrence   ClassRecurrence @default(WEEKLY)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  branch      Branch?    @relation(fields: [branchId], references: [id], onDelete: SetNull)
  instructor  User?      @relation("ClassInstructor", fields: [instructorId], references: [id], onDelete: SetNull)
  schedules   Schedule[]
  enrollments Enrollment[]

  @@map("classes")
}

enum ClassRecurrence {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  BIANNUAL
  YEARLY
}

model Schedule {
  id        String   @id @default(uuid())
  classId   String
  saloonId  String?
  dayOfWeek Int      // 0 = Sunday, 6 = Saturday
  startTime String   // Format: "HH:MM"
  endTime   String   // Format: "HH:MM"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  class  Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  saloon Saloon? @relation(fields: [saloonId], references: [id], onDelete: SetNull)

  @@map("schedules")
}

model Enrollment {
  id        String   @id @default(uuid())
  userId    String
  classId   String
  status    EnrollmentStatus @default(ACTIVE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  class      Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  attendance Attendance[]

  @@unique([userId, classId])
  @@map("enrollments")
}

enum EnrollmentStatus {
  ACTIVE
  INACTIVE
  COMPLETED
}

model Attendance {
  id           String           @id @default(uuid())
  enrollmentId String
  date         DateTime
  status       AttendanceStatus @default(PRESENT)
  notes        String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, date])
  @@map("attendance")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

model Payment {
  id            String        @id @default(uuid())
  userId        String
  amount        Float
  status        PaymentStatus @default(PENDING)
  description   String?
  paymentDate   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Expense {
  id          String        @id @default(uuid())
  category    ExpenseCategory
  amount      Float
  description String
  date        DateTime
  vendor      String?
  receipt     String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("expenses")
}

enum ExpenseCategory {
  RENT
  UTILITIES
  SALARIES
  EQUIPMENT
  MARKETING
  SUPPLIES
  MAINTENANCE
  INSURANCE
  OTHER
}

// ============= BRANCH & SALOON MANAGEMENT =============

model Branch {
  id             String   @id @default(uuid())
  name           String
  address        String?
  phone          String?
  isActive       Boolean  @default(true)
  operatingStart String   @default("09:00")
  operatingEnd   String   @default("23:00")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  users   User[]
  saloons Saloon[]
  classes Class[]

  @@map("branches")
}

model Saloon {
  id        String   @id @default(uuid())
  branchId  String
  name      String
  capacity  Int?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch    Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  schedules Schedule[]

  @@map("saloons")
}

// ============= INSTRUCTOR PAYMENT CONFIGURATION =============

model InstructorPaymentConfig {
  id             String                @id @default(uuid())
  instructorId   String                @unique
  paymentType    InstructorPaymentType
  monthlySalary  Float?
  perLessonRate  Float?
  percentageRate Float?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  instructor User @relation(fields: [instructorId], references: [id], onDelete: Cascade)

  @@map("instructor_payment_configs")
}

enum InstructorPaymentType {
  MONTHLY_SALARY
  PER_LESSON
  PERCENTAGE
}

// ============= SCHOOL SETTINGS (SINGLETON) =============

model SchoolSettings {
  id           String   @id @default("default")
  schoolName   String   @default("DanceSuite")
  motto        String?
  logo         String?  @db.Text
  primaryColor String?  @default("#a855f7")
  theme        Theme    @default(LIGHT)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("school_settings")
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}
